# Telegram Бот "Золотая рыбка"

## Описание функционала

Telegram бот "Золотая рыбка" - это комплексное решение для заказа рыбы, состоящее из следующих компонентов:

1. **Telegram Bot** - Основной интерфейс взаимодействия с пользователями. 
   - Бот отправляет приветственное сообщение с ссылкой на Telegram Mini App
   - Пользователи оформляют заказы через Mini App, а не напрямую в боте
   - При команде `/admin` администраторам отправляется ссылка на веб-интерфейс администратора

2. **Telegram Mini App** - Интегрированное веб-приложение внутри Telegram для удобного оформления заказов.
   - Адаптивный интерфейс для выбора товаров
   - Простая система оформления заказа

3. **Веб-приложение администратора** - Панель управления для администраторов.
   - Просмотр всех заказов и управление ими
   - Отслеживание статусов заказов
   - Экспорт данных

4. **Сервис синхронизации** - Фоновый процесс для обработки данных.
   - Обработка устаревших лидов
   - Синхронизация статусов заказов
   - Очистка старых данных

## Файловая структура проекта

- **run.py** - Главный файл для запуска всей системы; единственный скрипт запуска
- **botf.py** - Код Telegram бота
- **main.py** - Код веб-приложения администратора
- **sync_service.py** - Код сервиса синхронизации
- **static/** - Статические файлы (CSS, JavaScript, изображения)
  - **css/** - Стили для веб-приложения
  - **img/** - Изображения
  - **webapp/** - Файлы для Telegram Mini App
  - **exports/** - Папка для экспортируемых данных
- **templates/** - HTML-шаблоны для веб-приложения
- **install.sh** - Скрипт для автоматической установки зависимостей
- **requirements.txt** - Список требуемых Python-пакетов
- **bot.db** - SQLite база данных для хранения данных бота

## Инструкция по установке и запуску

Эта инструкция поможет вам запустить всю систему "Золотая рыбка" на вашем компьютере без необходимости в дорогостоящих серверах или специальных знаниях.

### Предварительные требования

1. **Python 3.7+** - Установите Python с [официального сайта](https://www.python.org/downloads/)
2. **Pip** - Установщик пакетов Python (обычно устанавливается вместе с Python)
3. **Ngrok** - Для публичного доступа к локальному веб-серверу (скачайте с [ngrok.com](https://ngrok.com/download))

### Шаг 1: Скачайте и распакуйте файлы проекта

1. Скачайте архив с файлами проекта и распакуйте его в удобное место
2. Откройте командную строку/терминал и перейдите в папку с распакованными файлами:
   ```
   cd путь/к/папке/с/проектом
   ```

### Шаг 2: Установите зависимости

#### Вариант 1: Автоматическая установка (Linux/Mac)
Запустите скрипт установки:
```
./install.sh
```

#### Вариант 2: Ручная установка (для всех платформ)
Выполните следующую команду для установки всех необходимых библиотек:
```
pip install -r requirements.txt
```

### Шаг 3: Настройка Telegram бота

1. Создайте нового бота у [@BotFather](https://t.me/BotFather) в Telegram
2. Получите и скопируйте токен бота
3. Откройте файл `botf.py` в любом текстовом редакторе
4. Замените значение переменной `TOKEN` (около строки 34) на ваш токен:
   ```python
   TOKEN = "ваш_токен_бота"
   ```
5. Замените `ADMIN_IDS` на ID ваших администраторов:
   ```python
   ADMIN_IDS = [ваш_id_в_telegram]
   ```
   (Узнать свой ID можно у бота [@userinfobot](https://t.me/userinfobot))

### Шаг 4: Настройка публичного доступа через туннелирование

#### Вариант 1: Через LocalTunnel (работает в РФ)

1. Установите LocalTunnel:
   ```
   npm install -g localtunnel
   ```

2. Откройте два терминала/командные строки

3. В первом терминале запустите LocalTunnel для веб-приложения администратора:
   ```
   lt --port 5000
   ```
   
4. Во втором терминале запустите LocalTunnel для Telegram Mini App:
   ```
   lt --port 8080
   ```

5. LocalTunnel покажет вам URL-адреса для доступа
   - Первый URL используйте для доступа к веб-приложению администратора
   - Второй URL используйте для настройки Telegram Mini App в BotFather

#### Вариант 2: Через Telebit (работает в РФ)

1. Установите Telebit:
   ```
   npm install -g telebit
   ```

2. Создайте туннели для обоих портов:
   ```
   telebit http 5000 -n admin
   telebit http 8080 -n webapp
   ```

3. Telebit покажет URL-адреса для доступа
   - Используйте их для настройки веб-приложения и Telegram Mini App

#### Вариант 3: Через Serveo (если доступен)

1. Запустите туннелирование через SSH для обоих портов:
   ```
   # Для веб-приложения администратора:
   ssh -R 80:localhost:5000 serveo.net
   
   # Для Telegram Mini App:
   ssh -R 80:localhost:8080 serveo.net
   ```

#### Вариант 4: Через Cloudflared (Argo Tunnel)

1. Скачайте и установите cloudflared с [официального сайта](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/)

2. Запустите туннели:
   ```
   # Для веб-приложения администратора:
   cloudflared tunnel --url http://localhost:5000
   
   # Для Telegram Mini App:
   cloudflared tunnel --url http://localhost:8080
   ```

### Шаг 5: Запуск системы

1. Запустите основной файл запуска:
   ```
   python run.py
   ```

2. Система автоматически запустит:
   - Telegram бота
   - Сервис синхронизации данных
   - Веб-приложение администратора на порту 5000
   - Telegram Mini App на порту 8080

3. Откройте бота в Telegram и проверьте его работу

### Доступ к веб-панели администратора

1. Веб-панель доступна по адресу:
   - Локально: http://localhost:5000
   - Через интернет: по URL, предоставленному Ngrok для порта 5000

2. Логин и пароль по умолчанию:
   - Логин: admin
   - Пароль: admin

### Устранение неполадок

1. **Порт 5000 или 8080 уже используется**
   - Система автоматически попытается освободить занятый порт
   - Если проблема сохраняется, найдите и завершите процесс, использующий порт:
     ```
     # На Linux/Mac
     lsof -i :5000
     kill <PID>
     
     # На Windows
     netstat -ano | findstr :5000
     taskkill /PID <PID> /F
     ```

2. **Бот не отвечает**
   - Убедитесь, что вы правильно настроили токен бота в `botf.py`
   - Проверьте логи на наличие ошибок
   - Перезапустите систему командой `python run.py`

3. **Проблема с дублированием процессов**
   - Система автоматически обнаруживает и завершает дублирующиеся процессы
   - Если проблема сохраняется, перед запуском run.py удалите файлы *.pid

4. **Веб-приложение или Mini App недоступны**
   - Убедитесь, что ngrok запущен и работает правильно
   - Проверьте, что на вашем компьютере не установлены файерволы, блокирующие порты

## Дополнительная информация

- База данных автоматически создается в файле `bot.db` при первом запуске
- Все логи выводятся в консоль, нет необходимости в дополнительных файлах логов
- Система автоматически перезапускает компоненты при сбоях
- Для остановки всей системы нажмите Ctrl+C в консоли запуска

## Рекомендации по развертыванию

1. **Локальная разработка и тестирование**
   - Используйте систему как описано выше с Ngrok для временного доступа

2. **Постоянное размещение на VPS**
   - Арендуйте виртуальный сервер (Digital Ocean, AWS, etc.)
   - Установите проект на сервер
   - Настройте веб-сервер (nginx) для проксирования запросов
   - Используйте systemd для автоматического запуска при перезагрузке

3. **Безопасность**
   - Не размещайте токен бота в публичном доступе
   - Измените пароль администратора после первого входа в веб-панель
   - При использовании в production-среде настройте HTTPS с Let's Encrypt