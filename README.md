# Telegram Бот "Золотая рыбка"

## Описание функционала

Telegram бот "Золотая рыбка" - это комплексное решение для заказа рыбы, состоящее из следующих компонентов:

1. **Telegram Bot** - Основной интерфейс взаимодействия с пользователями. 
   - Бот отправляет приветственное сообщение с ссылкой на Telegram Mini App
   - Пользователи оформляют заказы через Mini App, а не напрямую в боте
   - При команде `/admin` администраторам отправляется ссылка на веб-интерфейс администратора

2. **Telegram Mini App** - Интегрированное веб-приложение внутри Telegram для удобного оформления заказов.
   - Адаптивный интерфейс для выбора товаров
   - Простая система оформления заказа

3. **Веб-приложение администратора** - Панель управления для администраторов.
   - Просмотр всех заказов и управление ими
   - Отслеживание статусов заказов
   - Экспорт данных

4. **Сервис синхронизации** - Фоновый процесс для обработки данных.
   - Обработка устаревших лидов
   - Синхронизация статусов заказов
   - Очистка старых данных

## Файловая структура проекта

- **run.py** - Главный файл для запуска всей системы; единственный скрипт запуска
- **botf.py** - Код Telegram бота
- **main.py** - Код веб-приложения администратора
- **sync_service.py** - Код сервиса синхронизации
- **static/** - Статические файлы (CSS, JavaScript, изображения)
  - **css/** - Стили для веб-приложения
  - **img/** - Изображения
  - **webapp/** - Файлы для Telegram Mini App
  - **exports/** - Папка для экспортируемых данных
- **templates/** - HTML-шаблоны для веб-приложения
- **requirements.txt** - Список требуемых Python-пакетов
- **bot.db** - SQLite база данных для хранения данных бота

## Инструкция по установке и запуску

Эта инструкция поможет вам запустить всю систему "Золотая рыбка" на вашем компьютере с Windows.

### Предварительные требования

1. **Python 3.7+** - Установите Python с [официального сайта](https://www.python.org/downloads/)
2. **Pip** - Установщик пакетов Python (обычно устанавливается вместе с Python)
3. **cloudflared** (рекомендуется) - Для публичного доступа к локальному веб-серверу

### Шаг 1: Скачайте и распакуйте файлы проекта

1. Скачайте архив с файлами проекта и распакуйте его в удобное место
2. Откройте командную строку/терминал и перейдите в папку с распакованными файлами:
   ```
   cd путь\к\папке\с\проектом
   ```

### Шаг 2: Установите зависимости

Выполните следующую команду для установки всех необходимых библиотек:
```
pip install -r requirements.txt
```

### Шаг 3: Настройка Telegram бота

1. Создайте нового бота у [@BotFather](https://t.me/BotFather) в Telegram
2. Получите и скопируйте токен бота
3. Откройте файл `botf.py` в любом текстовом редакторе
4. Замените значение переменной `TOKEN` (около строки 34) на ваш токен:
   ```python
   TOKEN = "ваш_токен_бота"
   ```
5. Замените `ADMIN_IDS` на ID ваших администраторов:
   ```python
   ADMIN_IDS = [ваш_id_в_telegram]
   ```
   (Узнать свой ID можно у бота [@userinfobot](https://t.me/userinfobot))

### Шаг 4: Установка cloudflared (рекомендуется)

Для публичного доступа к веб-приложениям установите cloudflared:

1. Скачайте cloudflared с [официального сайта](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/)
2. Распакуйте и добавьте в PATH, или поместите в папку с проектом

### Шаг 5: Запуск системы

1. Запустите основной файл запуска:
   ```
   python run.py
   ```

2. Система автоматически запустит:
   - Telegram бота
   - Сервис синхронизации данных
   - Веб-приложение администратора на порту 5000
   - Telegram Mini App на порту 8080
   - cloudflared туннели (если установлен)

3. В консоли будут отображены адреса для доступа:
   - Локальные адреса (localhost)
   - Публичные адреса через cloudflared (если доступен)

4. Откройте бота в Telegram и проверьте его работу

### Доступ к веб-панели администратора

1. Веб-панель доступна по адресам:
   - Локально: http://localhost:5000
   - Через интернет: по URL, предоставленному cloudflared

2. Логин и пароль по умолчанию:
   - Логин: admin
   - Пароль: admin

### Настройка Telegram Mini App

1. После запуска системы скопируйте публичный URL для Mini App (порт 8080)
2. Перейдите к [@BotFather](https://t.me/BotFather) в Telegram
3. Выберите вашего бота и настройте Mini App:
   - Команда: `/setmenubutton`
   - Выберите вашего бота
   - Введите название кнопки: "Заказать рыбу"
   - Введите URL Mini App (публичный адрес с портом 8080)

### Устранение неполадок

1. **Порт 5000 или 8080 уже используется**
   - Система автоматически попытается освободить занятый порт
   - Если проблема сохраняется, перезапустите систему

2. **Бот не отвечает**
   - Убедитесь, что вы правильно настроили токен бота в `botf.py`
   - Проверьте логи на наличие ошибок
   - Перезапустите систему командой `python run.py`

3. **cloudflared не работает**
   - Убедитесь, что cloudflared установлен и доступен в PATH
   - Проверьте подключение к интернету
   - Система будет работать локально даже без cloudflared

4. **Веб-приложение или Mini App недоступны**
   - Проверьте, что порты 5000 и 8080 не заблокированы файерволом
   - Убедитесь, что все процессы запустились успешно (смотрите логи)

## Новые возможности версии 2.0

- **Удален gunicorn** - теперь используется только Flask для лучшей совместимости с Windows
- **Автоматический cloudflared** - система автоматически создает публичные туннели
- **Улучшенное логирование** - подробная информация о запуске и URL-адресах
- **Лучшая обработка ошибок** - более стабильная работа на Windows
- **Автоматическое освобождение портов** - система сама освобождает занятые порты

## Дополнительная информация

- База данных автоматически создается в файле `bot.db` при первом запуске
- Все логи выводятся в консоль с подробной информацией о состоянии системы
- Система автоматически перезапускает компоненты при сбоях
- Для остановки всей системы нажмите Ctrl+C в консоли запуска

## Рекомендации по развертыванию

1. **Локальная разработка и тестирование**
   - Используйте систему как описано выше с cloudflared для публичного доступа

2. **Постоянное размещение на VPS**
   - Арендуйте виртуальный сервер (Digital Ocean, AWS, etc.)
   - Установите проект на сервер
   - Настройте веб-сервер (nginx) для проксирования запросов
   - Используйте systemd для автоматического запуска при перезагрузке

3. **Безопасность**
   - Не размещайте токен бота в публичном доступе
   - Измените пароль администратора после первого входа в веб-панель
   - При использовании в production-среде настройте HTTPS с Let's Encrypt

## Техническая поддержка

При возникновении проблем:
1. Проверьте логи в консоли
2. Убедитесь, что все зависимости установлены
3. Проверьте настройки токена бота
4. Убедитесь, что порты 5000 и 8080 свободны